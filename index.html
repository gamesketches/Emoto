<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Emoto</title>
    <script type="text/javascript" src="phaser.min.js"></script>
</head>
<body>
  <script>
    // getUserMedia only works over https in Chrome 47+, so we redirect to https. Also notify user if running from file.
    if (window.location.protocol == "file:") {
      alert("You seem to be running this example directly from a file. Note that these examples only work when served from a server or localhost due to canvas cross-domain restrictions.");
    } else if (window.location.hostname !== "localhost" && window.location.protocol !== "https:"){
      window.location.protocol = "https";
    }
  </script>
  <script src="clmStuff/js/utils.js"></script>
  <script src="clmStuff/js/clmtrackr.js"></script>
  <script src="clmStuff/models/model_pca_20_svm_emotionDetection.js"></script>
  <script src="clmStuff/js/Stats.js"></script>
  <script src="clmStuff/examples/js/emotion_classifier.js"></script>
  <script src="clmStuff/examples/js/emotionmodel.js"></script>
  <video id="videoel" width="400" height="300" preload="auto" loop>
  </video>
  <video id="videoel2" width="400" height="300" preload="auto" loop>
  </video>
  <script type="text/javascript">
  var game = new Phaser.Game(800, 400, Phaser.AUTO, '',
        {preload: preload, create: create, update: update});

  // Tuning variables
  var maxVelocity = 700;
  var shotFrequency = 20;
  var maxLife = 20;
  var projectileVelocity = 1;

  var platforms, projectiles;
  var ctrack, ctrack2, classifier;
  var p1Ball, p2Ball;
  var vid = document.getElementById('videoel');
  var vid2 = document.getElementById('videoel2');
  function preload() {
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
    window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

    // check for camerasupport
    if (navigator.getUserMedia) {
      // set up stream

      var videoSelector = {video : true};
      if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
        var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
        if (chromeVersion < 20) {
          videoSelector = "video";
        }
      };

      var deviceId1;
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          var camera = devices.find(device => device.kind == "videoinput");
          if (camera) {
            console.log(camera.deviceId);
            var constraints = { deviceId: { exact: camera.deviceId } };
            deviceId1 = camera.deviceId;
            return navigator.mediaDevices.getUserMedia({ video: constraints });
          }
        })
        .then(stream => {vid.srcObject = stream; console.log(stream)})
        .catch(e => console.error(e));

        navigator.mediaDevices.enumerateDevices()
          .then(devices => {
            var deviceId2;
            devices.forEach(function(device) { if(device.kind == "videoinput" && device.deviceId != deviceId1) {
              deviceId2 = device.deviceId;
            }});
        var camera = devices.find(device => device.kind == "videoinput");
        var constraints = { deviceId: { exact: deviceId2 } };
        return navigator.mediaDevices.getUserMedia({ video: constraints });
        })
        .then(stream => {vid2.srcObject = stream; console.log(stream)})
        .catch(e => console.error(e));

      } else {
        //insertAltVideo(vid);
        alert("This demo depends on getUserMedia, which your browser does not seem to support. :(");
      }

    /*********** setup of emotion detection *************/

    ctrack = new clm.tracker({useWebGL : true});
    ctrack2 = new clm.tracker({useWebGL : true});
    ctrack.init(pModel);
    ctrack2.init(pModel);
    ctrack.start(vid);
    ctrack2.start(vid2);
    game.load.image("sadBall", "blue.png");
    game.load.image("angryBall", "red.png");
    game.load.image("brick", "brick.png");
  }

  function create() {

    game.physics.startSystem(Phaser.Physics.ARCADE);

    p1Ball = createPlayer({x: 40, y: 200});
    p2Ball = createPlayer({x: 400, y: 200});

    platforms = game.add.group();
    platforms.enableBody = true;
    platforms.physicsBodyType = Phaser.Physics.ARCADE;
    platforms.create(300, 300, 'brick');

    var vertBoundaries = game.make.bitmapData(800, 10);
    vertBoundaries.ctx.fillStyle = "#ff0000";
    vertBoundaries.ctx.fillRect(0, 0, 800, 10);

    //var bottom = platforms.preload(0, 390, vertBoundaries, 0);
    //bottom.body.immovable = true;

  	vid.play();
    vid2.play();
    classifier = new emotionClassifier();
    classifier.init(emotionModel);
    game.physics.arcade.velocityFromAngle(45, 500, p1Ball.body.velocity);
    game.physics.arcade.velocityFromAngle(45,-500, p2Ball.body.velocity);

    projectiles = game.add.group();
    projectiles.enableBody = true;
  }

  function update() {

    EmotionalControl(ctrack, p1Ball);
    EmotionalControl(ctrack2, p2Ball);
    function FlipDirection(p1Ball, p2Ball){
        p1Ball.body.velocity.x *= -1;
        p2Ball.body.velocity.x *= -1;
        p1Ball.body.velocity.y *= -1;
        p2Ball.body.velocity.y *= -1;
    }
    game.physics.arcade.collide(p1Ball, platforms, function(ball, brick) { brick.kill()}, function(ball, brick) { return true}, this);
    if(game.physics.arcade.overlap(p1Ball, p2Ball)) {
        FlipDirection(p1Ball, p2Ball);
    }
  /*  if(Phaser.Rectangle.intersects(white, passing)){
      game.state.add('gameOver', {
      			preload: function() {},
      			create: function (){
      							game.add.text(400, 300, 'Check your privilege', { fontSize: '32px', fill: '#FFF' });
                  },
      			update: function() {}
      		});
      game.state.start('gameOver');

    }
    */

  }

  function createPlayer(startLocation) {
    var ball = game.add.sprite(startLocation.x, startLocation.y, 'sadBall');
    ball.anchor.setTo(.5,.5);
    game.physics.enable(ball);
    ball.checkWorldBounds = true;
    ball.body.collideWorldBounds = true;
    ball.body.immovable = true;
    ball.body.bounce.set(1);

    return ball;
  }

  function EmotionalControl(tracker, ball) {
    var cp = tracker.getCurrentParameters();
    var er = classifier.meanPredict(cp);
    if(er) {
      ball.body.velocity.x = modifyVelocity(ball.body.velocity.x, er);
      ball.body.velocity.y = modifyVelocity(ball.body.velocity.y, er);
      if(er[0].value > er[1].value) {
          ball.loadTexture('angryBall');
      }
      else {
          ball.loadTexture('sadBall');
      }
    }
  }

  function modifyVelocity(vector, result) {
    var modifierValue = result[0].value > result[1].value ? result[0].value * 10 : result[1].value * -10;
    if(vector > 0) {
        return vector + modifierValue;
    }
    else{
        return vector - modifierValue;
    }
  }
</script>
</body>
</html>
